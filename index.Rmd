---
title: Web Scraping TecGEO
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: 
      version: 4
      font_scale: 1
      bootswatch: journal
      primary: "#2C3E50"
      secondary: "#EB6864"
    favicon: "img/logo.png"
    navbar:
      - { icon: "fa-link", href: "https://tecnologiageo.com.br/", align: right}
      - { icon: "fa-instagram", href: "https://www.instagram.com/tecgeobr/", align: right}
      - { icon: "fa-code", href: "https://tecnologiageo.com.br/", align: right}
    options: (shiny.maxRequestSize = 700*1024^2)
runtime: shiny
---

```{r setup, include=FALSE}
options(shiny.autoreload = TRUE)
options(gargle_oob_default = TRUE)
library(flexdashboard)
library(dplyr)
library(fontawesome)
library(leaflet.extras)
library(reactable)
library(mapview)
library(stringr)
library(leaflet)
mapa2 <- function(df = NULL, imovel = NULL){
  renomeando_tipos <- function(x)
    stringr::str_split(x, "_")[[1L]][1L]
  
  if(is.null(df))
    return(mapview()@map)

  tipos <- purrr::map_chr(.x = df$tipo, .f = renomeando_tipos)
  
  dados <- 
    df |> 
    sf::st_as_sf(coords=c("longitude", "latitude"), crs = 4326) |> 
    dplyr::select(-z_lat, -z_lon, -url, -bairro_completo) 
  
  dados$tipo <- tipos
  
  if(!is.null(imovel)){
    dados <- 
      dados |> 
      dplyr::filter(tipo == imovel, alpha = 0)
    
    mapa <- dados |> 
      mapview::mapview(al)
  } else {
    mapa <- dados |> 
      mapview::mapview(legend = F, alpha = 0)
  }
  
  return(mapa@map)
}
```

# Sobre {data-icon="fa-home"}


```{r  eval=require('leaflet'), echo = FALSE}
df_map <- reactive({leaflet() |>
  addMarkers(-34.8655664, -7.1214628) |>
  leaflet::addTiles() |>
  setView(
  -34.8655664, -7.1214628, zoom = 27
)})
renderLeaflet({df_map()})
```

Row {data-width=full}
-------------------------------------

###
```{r}
    modalDialog(
      title = NULL,
      "Visualize esse dashboard pela tela de um computador. Você poderá enfrentar dificuldades para",
      "visualizar e manipular alguns elementos, caso esteja utilizando um dispositivo móvel de tela pequena.",
      "Nesses dispositivos, visualizar na horizontal poderá ajudar na renderização dos conteúdos.",
      easyClose = FALSE,
      footer = modalButton("Entendi")
    )
```


Essa aplicação tem como objetivo facilitar a visualização dos dados raspados de imóveis anunciados em um detreminado município. Para tanto, ela irá funcionar com os arquivos no formato Comma Separated Values - CSV gerados pelo webscraping.
 
**Algumas observação**:

1 - Basta fazer o upload do arquivo CSV;

2 - Você deve aguardar a renderização completa do mapa;

3 - O mapa é produzido usando a biblioteca [**leaflet**](https://rstudio.github.io/leaflet/), da linguagem R e essa aplicação é construída usando a biblioteca [**shiny**](https://shiny.posit.co/) da linguagem R.

Row {data-height=100}
-------------------------------------

# Carregar arquivo CSV {data-navmenu="Construir Mapa" data-icon="fa-database"}

### `r fa("file-csv", fill = "darkblue")` Após o carregamento do CSV, aguarde até a renderização do mapa

```{r   eval=require('leaflet'), echo = FALSE}
library(spsComps)
options(shiny.maxRequestSize=700*1024^2)


dataset <- reactiveVal(NA)  # ReactiveVal para armazenar o conjunto de dados

observeEvent(input$arquivo, {
  data <- read.csv(input$arquivo$datapath)
  dataset(data)  # Atualizar o reactiveVal com o novo conjunto de dados
})

fileInput(
  "arquivo",
  "",
  buttonLabel = "Procure o CSV",
  placeholder = "Nenhum arquivo selecionado",
  accept = ".csv",
  width = '100%'
)

loader1 <- addLoader$new(
    target_selector = "m",
    footer = h4("Aguarde alguns instantes ..."),
    type = "ellipsis",
    z_index = 1000
)

renderLeaflet({
  # tryCatch({
  #   req(dataset())  # Verificar se o conjunto de dados está disponível
  #   loader1$show()
  #   on.exit(loader1$hide())
  #   cat("Aguarde ...")
  #   dados <- dataset()
  #   mapa2(dados)@map  # Renderizar o mapa
  # }, error = function(e) {
  #   mapview()@map  # Retornar um mapa vazio em caso de erro
  # })
  dados <- dataset()
  
  tryCatch(
    {
      req(dataset())
      dados <- dataset()
      mapa2(df = dados)
    }, error = function(e){
      mapview()@map
    }
  )})
```

### `r fa("table", fill = "darkblue")` Tabela Resumo


```{r}
  renderReactable({
  req(dataset())
  dados <- dataset() |> 
    dplyr::select(bairro, valor, area) |> 
    group_by(bairro) |> 
    summarise(valor_mediano = round(median(valor), 2L), valor_mediano_m2 = round(median(valor) / median(area), 2L), total = n()) |> 
    filter(total > 10L)
  
  tab <- reactable(
    dados,
    filterable = TRUE,
    defaultPageSize = 15L,
    columns = list(
        valor_mediano_m2 = colDef(
          style = function(value) {
            color <- ifelse(log(value) > median(log(dados$valor_mediano_m2)), "#f1625c", "#5cf1b4")
            list(background = color)
          }
        )
      )
  )
  tab
})
```


